<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Shipping Load Live Scroller v4</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* same styles as before, unchanged */
    :root{--color-white:rgba(255,255,255,1);--color-black:rgba(0,0,0,1);--color-cream-50:rgba(252,252,249,1);--color-cream-100:rgba(255,255,253,1);--color-gray-200:rgba(245,245,245,1);--color-gray-300:rgba(167,169,169,1);--color-gray-400:rgba(119,124,124,1);--color-slate-500:rgba(98,108,113,1);--color-brown-600:rgba(94,82,64,1);--color-charcoal-700:rgba(31,33,33,1);--color-charcoal-800:rgba(38,40,40,1);--color-slate-900:rgba(19,52,59,1);--color-teal-300:rgba(50,184,198,1);--color-teal-400:rgba(45,166,178,1);--color-teal-500:rgba(33,128,141,1);--color-teal-600:rgba(29,116,128,1);--color-teal-700:rgba(26,104,115,1);--color-teal-800:rgba(41,150,161,1);--color-red-400:rgba(255,84,89,1);--color-red-500:rgba(192,21,47,1);--color-orange-400:rgba(230,129,97,1);--color-orange-500:rgba(168,75,47,1);--color-brown-600-rgb:94,82,64;--color-teal-500-rgb:33,128,141;--color-slate-900-rgb:19,52,59;--color-slate-500-rgb:98,108,113;--color-red-500-rgb:192,21,47;--color-red-400-rgb:255,84,89;--color-orange-500-rgb:168,75,47;--color-orange-400-rgb:230,129,97;--color-gray-400-rgb:119,124,124;--color-gray-300-rgb:167,169,169;--color-gray-200-rgb:245,245,245;--color-bg-1:rgba(59,130,246,.08);--color-bg-2:rgba(245,158,11,.08);--color-bg-3:rgba(34,197,94,.08);--color-bg-4:rgba(239,68,68,.08);--color-bg-5:rgba(147,51,234,.08);--color-bg-6:rgba(249,115,22,.08);--color-bg-7:rgba(236,72,153,.08);--color-bg-8:rgba(6,182,212,.08);--color-background:var(--color-cream-50);--color-surface:var(--color-cream-100);--color-text:var(--color-slate-900);--color-text-secondary:var(--color-slate-500);--color-primary:var(--color-teal-500);--color-primary-hover:var(--color-teal-600);--color-primary-active:var(--color-teal-700);--color-secondary:rgba(var(--color-brown-600-rgb),.12);--color-secondary-hover:rgba(var(--color-brown-600-rgb),.2);--color-secondary-active:rgba(var(--color-brown-600-rgb),.25);--color-border:rgba(var(--color-brown-600-rgb),.2);--color-btn-primary-text:var(--color-cream-50);--color-card-border:rgba(var(--color-brown-600-rgb),.12);--color-card-border-inner:rgba(var(--color-brown-600-rgb),.12);--color-error:var(--color-red-500);--color-success:var(--color-teal-500);--color-warning:var(--color-orange-500);--color-info:var(--color-slate-500);--color-focus-ring:rgba(var(--color-teal-500-rgb),.4);--color-select-caret:rgba(var(--color-slate-900-rgb),.8);--color-green:rgba(34,197,94,1);--color-yellow:rgba(234,179,8,1);--color-red:rgba(239,68,68,1);--color-green-bg:rgba(34,197,94,.1);--color-yellow-bg:rgba(234,179,8,.1);--color-red-bg:rgba(239,68,68,.1);--font-family-base:"FKGroteskNeue","Geist","Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;--font-family-mono:"Berkeley Mono",ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;--font-size-xs:11px;--font-size-sm:12px;--font-size-base:14px;--font-size-md:14px;--font-size-lg:16px;--font-size-xl:18px;--font-size-2xl:20px;--font-size-3xl:24px;--font-weight-normal:400;--font-weight-medium:500;--font-weight-semibold:550;--font-weight-bold:600;--line-height-tight:1.2;--line-height-normal:1.5;--space-4:4px;--space-8:8px;--space-12:12px;--space-16:16px;--space-20:20px;--space-24:24px;--space-32:32px;--radius-sm:6px;--radius-base:8px;--radius-md:10px;--radius-lg:12px;--radius-full:9999px;--shadow-sm:0 1px 3px rgba(0,0,0,.04),0 1px 2px rgba(0,0,0,.02);--shadow-md:0 4px 6px -1px rgba(0,0,0,.04),0 2px 4px -1px rgba(0,0,0,.02);--duration-fast:150ms;--duration-normal:250ms;--ease-standard:cubic-bezier(.16,1,.3,1)}
    @media(prefers-color-scheme:dark){:root{--color-background:var(--color-charcoal-700);--color-surface:var(--color-charcoal-800);--color-text:var(--color-gray-200);--color-text-secondary:rgba(var(--color-gray-300-rgb),.7);--color-primary:var(--color-teal-300);--color-primary-hover:var(--color-teal-400);--color-primary-active:var(--color-teal-800);--color-secondary:rgba(var(--color-gray-400-rgb),.15);--color-secondary-hover:rgba(var(--color-gray-400-rgb),.25);--color-secondary-active:rgba(var(--color-gray-400-rgb),.3);--color-border:rgba(var(--color-gray-400-rgb),.3);--color-error:var(--color-red-400);--color-success:var(--color-teal-300);--color-warning:var(--color-orange-400);--color-btn-primary-text:var(--color-slate-900);--color-card-border:rgba(var(--color-gray-400-rgb),.2);--color-card-border-inner:rgba(var(--color-gray-400-rgb),.15)}}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:var(--font-family-base);background:var(--color-background);color:var(--color-text);overflow-x:hidden}
    .container{min-height:100vh;display:flex;flex-direction:column}
    .header{background:var(--color-surface);border-bottom:1px solid var(--color-border)}
    .header-row{display:flex;justify-content:space-between;align-items:center;padding:var(--space-20) var(--space-32);border-bottom:1px solid var(--color-border)}
    .header-row:last-child{border-bottom:none}
    .header-left{display:flex;flex-direction:column;gap:var(--space-4)}
    .header h1{font-size:var(--font-size-3xl);font-weight:var(--font-weight-bold)}
    .header-date{font-size:var(--font-size-base);color:var(--color-text-secondary);font-weight:var(--font-weight-medium)}
    .controls{display:flex;gap:var(--space-16);align-items:center}
    .tab-buttons{display:flex;gap:var(--space-8);flex-wrap:wrap}
    .tab-btn{padding:var(--space-8) var(--space-16);background:transparent;border:1px solid var(--color-border);border-radius:var(--radius-sm);color:var(--color-text);cursor:pointer;transition:all var(--duration-fast) var(--ease-standard);font-size:var(--font-size-base);font-weight:var(--font-weight-medium);font-family:var(--font-family-base)}
    .tab-btn:hover{background:var(--color-secondary-hover)}
    .tab-btn.active{background:var(--color-primary);color:var(--color-btn-primary-text);border-color:var(--color-primary)}
    .current-time{font-size:var(--font-size-base);color:var(--color-text-secondary);font-weight:var(--font-weight-medium);white-space:nowrap}
    .scroller-container{flex:1;overflow-y:auto;padding:var(--space-24) var(--space-32);position:relative}
    .section{margin-bottom:var(--space-32)}
    .section-title{font-size:var(--font-size-xl);font-weight:var(--font-weight-bold);margin-bottom:var(--space-16);color:var(--color-text);padding-bottom:var(--space-12);border-bottom:2px solid var(--color-border)}
    .scroller{display:flex;flex-direction:column;gap:var(--space-16)}
    .load-card{background:var(--color-surface);border:2px solid;border-radius:var(--radius-lg);padding:var(--space-20) var(--space-24);display:flex;justify-content:space-between;align-items:center;min-height:80px;transition:transform var(--duration-fast) var(--ease-standard)}
    .load-card:hover{transform:translateY(-2px)}
    body.mobile-view .load-card{padding:12px 14px;min-height:60px}
    body.mobile-view .load-store{font-size:var(--font-size-xl)}
    body.mobile-view .scheduled-time{font-size:var(--font-size-lg)}
    body.mobile-view .time-remaining{font-size:var(--font-size-sm)}
    body.tv-view .load-card{padding:24px 28px;min-height:90px}
    body.tv-view .load-store{font-size:28px}
    body.tv-view .scheduled-time{font-size:24px}
    body.tv-view .time-remaining{font-size:16px}
    .load-card.green{border-color:var(--color-green);background:var(--color-green-bg)}
    .load-card.yellow{border-color:var(--color-yellow);background:var(--color-yellow-bg)}
    .load-card.red{border-color:var(--color-red);background:var(--color-red-bg)}
    .load-card.completed{border-color:var(--color-border);background:var(--color-surface);opacity:.6}
    .load-card.completed .load-store{text-decoration:line-through}
    .load-info{display:flex;gap:var(--space-32);align-items:center}
    .load-type{font-size:var(--font-size-sm);font-weight:var(--font-weight-bold);text-transform:uppercase;letter-spacing:.5px;color:var(--color-text-secondary)}
    .load-store{font-size:var(--font-size-3xl);font-weight:var(--font-weight-bold);color:var(--color-text)}
    .load-time{display:flex;flex-direction:column;align-items:flex-end;gap:var(--space-4)}
    .scheduled-time{font-size:var(--font-size-2xl);font-weight:var(--font-weight-bold);color:var(--color-text)}
    .time-remaining{font-size:var(--font-size-base);font-weight:var(--font-weight-medium)}
    .load-card.green .time-remaining{color:var(--color-green)}
    .load-card.yellow .time-remaining{color:var(--color-yellow)}
    .load-card.red .time-remaining{color:var(--color-red)}
    .legend{position:fixed;bottom:var(--space-24);right:var(--space-32);background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-base);padding:var(--space-16);display:flex;gap:var(--space-20);font-size:var(--font-size-sm);box-shadow:var(--shadow-md)}
    .legend-item{display:flex;align-items:center;gap:var(--space-8)}
    .legend-color{width:20px;height:20px;border-radius:var(--radius-sm)}
    .legend-color.green{background:var(--color-green)}
    .legend-color.yellow{background:var(--color-yellow)}
    .legend-color.red{background:var(--color-red)}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center}
    .modal.active{display:flex}
    .modal-content{background:var(--color-surface);border-radius:var(--radius-lg);padding:var(--space-32);max-width:800px;max-height:80vh;overflow-y:auto;width:90%;box-shadow:var(--shadow-md)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-20)}
    .modal-header h2{margin:0;font-size:var(--font-size-2xl);font-weight:var(--font-weight-bold)}
    .close-btn{background:var(--color-secondary);border:none;border-radius:var(--radius-sm);padding:var(--space-8) var(--space-16);cursor:pointer;font-size:var(--font-size-base);font-weight:var(--font-weight-medium);color:var(--color-text);font-family:var(--font-family-base);transition:background var(--duration-fast) var(--ease-standard)}
    .close-btn:hover{background:var(--color-secondary-hover)}
    .data-editor{font-family:var(--font-family-mono);font-size:var(--font-size-sm);width:100%;min-height:400px;padding:var(--space-16);border:1px solid var(--color-border);border-radius:var(--radius-base);background:var(--color-background);color:var(--color-text);resize:vertical}
    .modal-actions{display:flex;gap:var(--space-12);margin-top:var(--space-20)}
    .save-btn{background:var(--color-primary);color:var(--color-btn-primary-text);border:none;border-radius:var(--radius-sm);padding:var(--space-12) var(--space-20);cursor:pointer;font-size:var(--font-size-base);font-weight:var(--font-weight-medium);font-family:var(--font-family-base);transition:background var(--duration-fast) var(--ease-standard)}
    .save-btn:hover{background:var(--color-primary-hover)}
    .sync-status{font-size:var(--font-size-sm);color:var(--color-text-secondary);padding:var(--space-8) var(--space-12);background:rgba(var(--color-teal-500-rgb),.1);border-radius:var(--radius-sm);white-space:nowrap}
    @media(max-width:768px){.header-row{flex-direction:column;align-items:flex-start;gap:var(--space-16);padding:var(--space-16)}.controls{flex-direction:column;width:100%;align-items:flex-start}.tab-buttons{width:100%}.scroller-container{padding:var(--space-16)}.load-card{flex-direction:column;align-items:flex-start;gap:var(--space-16)}.load-time{align-items:flex-start}.legend{position:static;margin-top:var(--space-24);flex-direction:column}}
  </style>
</head>
<body class="tv-view">
  <div class="container">
    <div class="header">
      <div class="header-row">
        <div class="header-left">
          <h1>Shipping Load Live Scroller</h1>
          <div class="header-date" id="headerDate"></div>
        </div>
        <div class="current-time" id="currentTime"></div>
        <div class="controls">
          <div class="tab-buttons">
            <button class="tab-btn" id="mobileViewBtn" onclick="setViewMode('mobile')">ðŸ“± Mobile View</button>
            <button class="tab-btn active" id="tvViewBtn" onclick="setViewMode('tv')">ðŸ“º TV View</button>
          </div>
        </div>
      </div>
      <div class="header-row">
        <div class="controls">
          <div class="tab-buttons">
            <button class="tab-btn active" data-sheet="urgent">Urgent</button>
            <button class="tab-btn" data-sheet="completed">Completed</button>
            <button class="tab-btn" data-sheet="all">All</button>
            <button class="tab-btn" data-sheet="grocery">Grocery</button>
            <button class="tab-btn" data-sheet="produce">Produce</button>
          </div>
        </div>
        <div class="controls">
          <div class="tab-buttons">
            <button class="tab-btn" onclick="showDataEditor('grocery')">ðŸ“‹ Grocery Data</button>
            <button class="tab-btn" onclick="showDataEditor('produce')">ðŸ“‹ Produce Data</button>
            <button class="tab-btn" onclick="manualRefresh()">ðŸ”„ Refresh Data</button>
          </div>
        </div>
      </div>
    </div>

    <div class="scroller-container">
      <div class="section">
        <h2 class="section-title" id="sectionTitle">Pending Loads for Today</h2>
        <div class="scroller" id="urgentScroller"></div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item"><div class="legend-color green"></div><span>&gt; 2 hours</span></div>
      <div class="legend-item"><div class="legend-color yellow"></div><span>20-45 min</span></div>
      <div class="legend-item"><div class="legend-color red"></div><span>&lt; 20 min</span></div>
      <div class="legend-item sync-status" id="syncStatus">âœ… Synced</div>
    </div>
  </div>

  <div class="modal" id="dataModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Edit Data</h2>
        <button class="close-btn" onclick="closeDataEditor()">Close</button>
      </div>
      <p style="color: var(--color-text-secondary); margin-bottom: 15px;">
        Edit the JSON data below. Format: { "store": number, "store_name": "Name", "mon": "TIME", "tue": "TIME", ... }
      </p>
      <textarea class="data-editor" id="dataEditor"></textarea>
      <div class="modal-actions">
        <button class="save-btn" onclick="saveData()">Save Changes</button>
        <button class="close-btn" onclick="closeDataEditor()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let scheduleData = { grocery: [], produce: [], combined: [] };
    const dayMap = {0:'sun',1:'mon',2:'tue',3:'wed',4:'thu',5:'fri',6:'sat'};
    let currentFilter = 'urgent';
    let selectedDate = null;
    let currentEditingType = null;

    function excelSerialToTimeString(serial) {
      if (typeof serial !== 'number' || isNaN(serial)) return null;
      const totalMinutes = Math.round(serial * 24 * 60);
      let hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      const period = hours >= 12 ? 'PM' : 'AM';
      if (hours === 0) hours = 12;
      else if (hours > 12) hours -= 12;
      return `${hours}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    function normalizeData(data) {
      const dayKeys = ['mon','tue','wed','thu','fri','sat','sun'];
      return data.map(row => {
        const cleaned = {};
        Object.keys(row).forEach(key => {
          const trimmedKey = key.trim().toLowerCase();
          const value = row[key];
          if (value === undefined || value === '') return;
          if (dayKeys.includes(trimmedKey)) {
            if (typeof value === 'number') {
              const asTime = excelSerialToTimeString(value);
              if (asTime) cleaned[trimmedKey] = asTime;
            } else {
              cleaned[trimmedKey] = value.toString().trim();
            }
          } else if (trimmedKey === 'store') {
            cleaned[trimmedKey] = Number(value);
          } else {
            cleaned[trimmedKey] = value.toString().trim();
          }
        });
        return cleaned;
      });
    }

    function updateSyncStatus(status) {
      const syncEl = document.getElementById('syncStatus');
      if (syncEl) syncEl.textContent = status;
    }

    async function loadExcelFromGitHub() {
      try {
        const groceryUrl = 'https://docs.google.com/spreadsheets/d/1pKeHsUcVTdR5kAyxoL_Sg8gfO2Imu3_k/export?format=xlsx';
        const produceUrl = 'https://docs.google.com/spreadsheets/d/1SHtXezBCYySUzEoAJKpJ2lSFxI-i4zo8/export?format=xlsx'; [web:147]
        const groceryRes = await fetch(groceryUrl);
        const produceRes = await fetch(produceUrl);
        if (groceryRes.ok && produceRes.ok) {
          const groceryData = await groceryRes.arrayBuffer();
          const produceData = await produceRes.arrayBuffer();
          const groceryWorkbook = XLSX.read(groceryData,{type:'array'});
          const produceWorkbook = XLSX.read(produceData,{type:'array'});
          const grocerySheet = groceryWorkbook.Sheets[groceryWorkbook.SheetNames[0]];
          const produceSheet = produceWorkbook.Sheets[produceWorkbook.SheetNames[0]];
          scheduleData.grocery = normalizeData(XLSX.utils.sheet_to_json(grocerySheet));
          scheduleData.produce = normalizeData(XLSX.utils.sheet_to_json(produceSheet)); [file:133][file:134]
          updateSyncStatus('âœ… Synced from Google Sheets');
          renderScroller();
        } else {
          updateSyncStatus('âš ï¸ Using cached data');
          console.log('Could not fetch Excel from Google Sheets');
        }
      } catch (e) {
        updateSyncStatus('âš ï¸ Using cached data');
        console.log('Error loading Excel from Google Sheets:', e.message);
      }
    }

    function manualRefresh() {
      updateSyncStatus('â³ Syncing...');
      loadExcelFromGitHub();
    }

    // Updated parser to handle 700, 700 PM, 7:00 PM, etc.
    function parseTime(timeStr) {
      if (!timeStr) return { hours: 0, minutes: 0 };
      let s = String(timeStr).trim().toUpperCase();

      // Pure digits like 700, 730
      if (/^\d{3,4}$/.test(s)) {
        const num = parseInt(s,10);
        const minutes = num % 100;
        let hours = Math.floor(num/100);
        let period = 'PM';
        if (hours === 12) period = 'PM';
        else if (hours === 0) { hours = 12; period = 'AM'; }
        if (period === 'PM' && hours !== 12) hours += 12;
        if (period === 'AM' && hours === 12) hours = 0;
        return { hours, minutes };
      }

      // 700 PM -> 7:00 PM
      const noColon = s.match(/^(\d{3,4})\s*(AM|PM)$/);
      if (noColon) {
        const num = parseInt(noColon[1],10);
        const minutes = num % 100;
        let hours = Math.floor(num/100);
        const period = noColon[2];
        if (period === 'PM' && hours !== 12) hours += 12;
        if (period === 'AM' && hours === 12) hours = 0;
        return { hours, minutes };
      }

      const match = s.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/);
      if (!match) return { hours: 0, minutes: 0 };
      let hours = parseInt(match[1],10);
      const minutes = parseInt(match[2],10);
      const period = match[3];
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;
      return { hours, minutes };
    }

    function getTimeStatus(scheduledTime) {
      const now = new Date();
      const scheduled = new Date(now);
      const { hours, minutes } = parseTime(scheduledTime);
      scheduled.setHours(hours, minutes, 0, 0);
      const diffMinutes = (scheduled - now) / (1000 * 60);
      if (diffMinutes > 120) return 'green';
      if (diffMinutes >= 20 && diffMinutes <= 45) return 'yellow';
      if (diffMinutes < 20 && diffMinutes >= 0) return 'red';
      return 'green';
    }

    function formatTimeRemaining(scheduledTime) {
      const now = new Date();
      const scheduled = new Date(now);
      const { hours, minutes } = parseTime(scheduledTime);
      scheduled.setHours(hours, minutes, 0, 0);
      const diffMinutes = Math.round((scheduled - now) / (1000 * 60));
      if (diffMinutes < 0) {
        const absDiff = Math.abs(diffMinutes);
        const hrs = Math.floor(absDiff/60);
        const mins = absDiff%60;
        return hrs>0 ? `${hrs}h ${mins}m ago` : `${mins}m ago`;
      }
      const hrs = Math.floor(diffMinutes/60);
      const mins = diffMinutes%60;
      return hrs>0 ? `${hrs}h ${mins}m remaining` : `${mins}m remaining`;
    }

    function getMinutesUntilLoad(timeStr) {
      const now = new Date();
      const scheduled = new Date(now);
      const { hours, minutes } = parseTime(timeStr);
      scheduled.setHours(hours, minutes, 0, 0);
      return Math.round((scheduled - now) / (1000 * 60));
    }

    function getLoadsForToday() {
      let now;
      if (selectedDate) {
        const parts = selectedDate.split('-');
        now = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
      } else {
        now = new Date();
      }
      const today = dayMap[now.getDay()];
      const loads = [];
      Object.keys(scheduleData).forEach(type => {
        if (currentFilter!=='urgent' && currentFilter!=='completed' && currentFilter!=='all' && currentFilter!==type) return;
        scheduleData[type].forEach(load => {
          if (load[today]) {
            const typeName = type.charAt(0).toUpperCase()+type.slice(1);
            loads.push({
              type:typeName,
              store:load.store,
              store_name:load.store_name || '',
              time:load[today],
              timeStatus:getTimeStatus(load[today]),
              status:'pending'
            });
          }
        });
      });
      return loads;
    }

    function formatDisplayTime(timeStr) {
      const { hours, minutes } = parseTime(timeStr);
      let h12 = hours % 12;
      if (h12 === 0) h12 = 12;
      const period = hours >= 12 ? 'PM' : 'AM';
      return `${h12}:${minutes.toString().padStart(2,'0')} ${period}`;
    }

    function renderLoadCard(load) {
      const minutesUntil = getMinutesUntilLoad(load.time);
      const cardClass = minutesUntil < 0 ? 'completed' : load.timeStatus;
      const storeLabel = load.store_name ? `${load.store} - ${load.store_name}` : `Store ${load.store}`;
      return `
        <div class="load-card ${cardClass}">
          <div class="load-info">
            <div class="load-type">${load.type}</div>
            <div class="load-store">${storeLabel}</div>
          </div>
          <div class="load-time">
            <div class="scheduled-time">${formatDisplayTime(load.time)}</div>
            <div class="time-remaining">${formatTimeRemaining(load.time)}</div>
          </div>
        </div>
      `;
    }

    function renderScroller() {
      const allLoads = getLoadsForToday();
      let now;
      if (selectedDate) {
        const parts = selectedDate.split('-');
        now = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
      } else {
        now = new Date();
      }
      const dateStr = now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      if (currentFilter === 'completed') {
        const completedLoads = allLoads
          .filter(load => getMinutesUntilLoad(load.time) < 0)
          .sort((a,b) => {
            const ta = parseTime(a.time), tb = parseTime(b.time);
            return (ta.hours*60+ta.minutes) - (tb.hours*60+tb.minutes);
          });
        document.getElementById('sectionTitle').textContent = `Completed Loads for ${selectedDate ? dateStr : 'Today'} (${completedLoads.length})`;
        document.getElementById('urgentScroller').innerHTML =
          completedLoads.length ? completedLoads.map(renderLoadCard).join('') :
          '<p style="color: var(--color-text-secondary); padding: 20px;">No completed loads for today</p>';
      } else {
        const pendingLoads = allLoads
          .filter(load => getMinutesUntilLoad(load.time) >= 0)
          .sort((a,b) => {
            const ta = parseTime(a.time), tb = parseTime(b.time);
            return (ta.hours*60+ta.minutes) - (tb.hours*60+tb.minutes);
          });
        document.getElementById('sectionTitle').textContent = `Pending Loads for ${selectedDate ? dateStr : 'Today'} (${pendingLoads.length})`;
        document.getElementById('urgentScroller').innerHTML =
          pendingLoads.length ? pendingLoads.map(renderLoadCard).join('') :
          `<p style="color: var(--color-text-secondary); padding: 20px;">No pending loads for ${selectedDate ? dateStr : 'today'}</p>`;
      }
    }

    function updateCurrentTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
      const fullDateStr = now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      document.getElementById('currentTime').textContent = timeStr;
      document.getElementById('headerDate').textContent = fullDateStr;
    }

    document.querySelectorAll('.tab-btn[data-sheet]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn[data-sheet]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.sheet;
        renderScroller();
      });
    });

    function showDataEditor(type) {
      currentEditingType = type;
      const modal = document.getElementById('dataModal');
      const editor = document.getElementById('dataEditor');
      const title = document.getElementById('modalTitle');
      title.textContent = `Edit ${type.charAt(0).toUpperCase()+type.slice(1)} Data`;
      editor.value = JSON.stringify(scheduleData[type], null, 2);
      modal.classList.add('active');
    }

    function closeDataEditor() {
      document.getElementById('dataModal').classList.remove('active');
      currentEditingType = null;
    }

    async function saveData() {
      const editor = document.getElementById('dataEditor');
      try {
        const newData = JSON.parse(editor.value);
        scheduleData[currentEditingType] = newData;
        renderScroller();
        const res = await fetch('/api/update-schedule',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ scheduleData })
        });
        if (!res.ok) {
          let msg = res.statusText;
          try {
            const err = await res.json();
            if (err && err.details) msg = err.details;
          } catch(_){}
          alert('Saved locally, but GitHub sync failed: ' + msg);
          return;
        }
        alert('Data saved and synced to GitHub successfully!');
        closeDataEditor();
      } catch(e) {
        alert('Invalid JSON format. Please check your data and try again.\n\nError: ' + e.message);
      }
    }

    function setViewMode(mode) {
      const body = document.body;
      const mobileBtn = document.getElementById('mobileViewBtn');
      const tvBtn = document.getElementById('tvViewBtn');
      if (mode === 'mobile') {
        body.classList.add('mobile-view');
        body.classList.remove('tv-view');
        mobileBtn.classList.add('active');
        tvBtn.classList.remove('active');
      } else {
        body.classList.add('tv-view');
        body.classList.remove('mobile-view');
        tvBtn.classList.add('active');
        mobileBtn.classList.remove('active');
      }
    }

    loadExcelFromGitHub();
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    setInterval(renderScroller, 60000);
    setInterval(loadExcelFromGitHub, 300000);
  </script>
</body>
</html>
